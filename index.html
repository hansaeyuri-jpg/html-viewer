<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>JSONL ì±„íŒ… ë§í’ì„  ë³´ê¸°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
    /* ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ë° ë””ìì¸ */
    body {
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background:#f5f5f5;
      padding:20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    #controls {
      margin-bottom:16px;
      width:100%;
      display:flex;
      justify-content:center;
    }
    
    /* â­ï¸ 2. íŒŒì¼ ì„ íƒ ë²„íŠ¼ ìŠ¤íƒ€ì¼ë§ ì¶”ê°€ â­ï¸ */
    #fileInput {
        font-size: 16px; /* í°íŠ¸ í¬ê¸° ì¡°ì • */
        padding: 10px; /* í„°ì¹˜ ì˜ì—­ í™•ë³´ */
        max-width: 90%; /* ëª¨ë°”ì¼ ë„ˆë¹„ì— ë§ê²Œ ì¡°ì • */
        border: 1px solid #ccc; /* ê²½ê³„ì„  ì¶”ê°€ */
        border-radius: 8px;
        background-color: #ffffff;
        cursor: pointer;
    }

    .message {
      max-width: 70%;
      padding:10px 14px;
      border-radius:16px;
      margin:6px 0;
      line-height:1.5;
      white-space:pre-wrap;
      word-break:break-word;
    }
    #chat {
      width: 100%;
      max-width: 700px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
    }
    .bubble-wrapper {
      display:flex;
      flex-direction:column;
      width:100%;
      align-items:center;
    }
    
    /* ì‚¬ìš©ì ë©”ì‹œì§€ (ì˜¤ë¥¸ìª½ ë§í’ì„ ) ìŠ¤íƒ€ì¼ */
    .from-user {
      background:var(--user-bg, #e8f7ff);
      text-align:left; 
      align-self: flex-end;
      margin-left: 0;
    }
    
    /* ë´‡ ë©”ì‹œì§€ (ì™¼ìª½ ë§í’ì„ ) ìŠ¤íƒ€ì¼ */
    .from-bot {
      background:var(--bot-bg, #fffbe6);
      text-align:left;
      align-self: flex-start;
      margin-right: 0;
    }
    
    /* ì´ë¦„(meta) ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    .meta {
      font-size:12px;
      color:#666;
      margin-bottom:2px;
    }
    
    /* ì´ë¦„ ì •ë ¬ */
    .from-user-meta {
      align-self: flex-end; /* ì‚¬ìš©ì ì´ë¦„ì€ ì˜¤ë¥¸ìª½ ì •ë ¬ */
    }
    .from-bot-meta {
      align-self: flex-start; /* ë´‡ ì´ë¦„ì€ ì™¼ìª½ ì •ë ¬ */
    }

    /* [ìŠ¤íƒ€ì¼ 1] í°ë”°ì˜´í‘œ: ë³´ë¼ìƒ‰ + êµµê²Œ */
    .highlight-purple {
      color: var(--highlight-color, #7c3aed);
      font-weight: 500;
    }

    /* [ìŠ¤íƒ€ì¼ 2] ë³„í‘œ(*): íšŒìƒ‰ + ê¸°ìš¸ì„ */
    .highlight-action {
      color: #868e96; 
      font-style: italic; 
    }

    /* [ìŠ¤íƒ€ì¼ 3] ë³„í‘œ 2ê°œ(**): êµµê²Œ */
    .highlight-bold {
      font-weight: 700;
    }
  
    /* ëª¨ë°”ì¼ ìµœì í™” ìŠ¤íƒ€ì¼ (ìˆ˜ì •ë¨) */
    @media (max-width: 768px) {
      body { padding: 10px !important; }
      #chat { width: 100% !important; max-width: 100% !important; }
      .message { max-width: 88% !important; font-size: 14px !important; }
      #controls input, #controls button, .meta { font-size: 13px !important; }
      .meta { font-size: 11px !important; }
    }

  
    /* ìƒˆë¡œìš´ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #controls {
      flex-direction: column; 
      gap: 10px;
      align-items: center;
    }
    .custom-file-btn {
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      text-align: center;
      width: 90%;
      max-width: 300px;
      display: inline-block;
    }
    .color-controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      width: 100%;
    }
    .color-btn-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 12px;
    }
    .color-btn-wrapper input[type="color"] {
      border: none;
      width: 40px;
      height: 40px;
      cursor: pointer;
      background: none;
    }

  </style>
</head>
<body>
  
  <div id="controls">
    <!-- íŒŒì¼ ì„ íƒ ë²„íŠ¼ (ì»¤ìŠ¤í…€) -->
    <label for="fileInput" class="custom-file-btn">ğŸ“‚ íŒŒì¼ ì„ íƒ</label>
    <input type="file" id="fileInput" accept=".jsonl" style="display:none;" />

    <!-- ìƒ‰ìƒ ë³€ê²½ ë²„íŠ¼ ê·¸ë£¹ -->
    <div class="color-controls">
      <div class="color-btn-wrapper">
        <label for="userColor">Userìƒ‰</label>
        <input type="color" id="userColor" value="#e8f7ff">
      </div>
      <div class="color-btn-wrapper">
        <label for="botColor">Charìƒ‰</label>
        <input type="color" id="botColor" value="#fffbe6">
      </div>
      <div class="color-btn-wrapper">
        <label for="highlightColor">ëŒ€ì‚¬ìƒ‰</label>
        <input type="color" id="highlightColor" value="#7c3aed">
      </div>
    </div>
  </div>


  <div id="chat"></div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const chat = document.getElementById('chat');

    // HTML íŠ¹ìˆ˜ë¬¸ì ì´ìŠ¤ì¼€ì´í”„
    function escapeHtml(text) {
      if (!text) return text;
      return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      
      // íŒŒì¼ ì½ê¸° ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ì²˜ë¦¬
      reader.onerror = (e) => {
        chat.innerHTML = `<div style="color: red; text-align: center; margin-top: 20px;">íŒŒì¼ì„ ì½ëŠ” ë„ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${reader.error.name}</div>`;
      };
      
      reader.onload = (event) => {
        chat.innerHTML = "";
        const text = event.target.result;
        
        // íŒŒì¼ ë‚´ìš©ì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
        if (!text || text.trim() === "") {
            chat.innerHTML = '<div style="color: red; text-align: center; margin-top: 20px;">íŒŒì¼ ë‚´ìš©ì´ ë¹„ì–´ ìˆê±°ë‚˜ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        const lines = text.split(/\r?\n/).filter(line => line.trim() !== "");
        let messageCount = 0; // ë©”ì‹œì§€ ë Œë”ë§ ì„±ê³µ ì¹´ìš´í„°

        lines.forEach((line) => {
          try {
            const obj = JSON.parse(line);
            
            // mes í‚¤ê°€ ì—†ëŠ” ì¤„ (ë©”íƒ€ë°ì´í„°)ì€ ê±´ë„ˆëœë‹ˆë‹¤.
            if (!obj.mes) {
                return; 
            }

            const name = obj.name || obj.user_name || "ì´ë¦„ ì—†ìŒ";
            const isUser = obj.is_user === true;
            
            // 1. ì¤„ë°”ê¿ˆ ë¬¸ì ë³µì›
            const rawMessage = (obj.mes || "").replace(/\\n/g, "\n").replace(/\\r/g, "\r");

            // 2. HTML ì´ìŠ¤ì¼€ì´í”„
            let safeMessage = escapeHtml(rawMessage);

            // 3. ì„œì‹ ì ìš©
            let formattedMessage = safeMessage
              // (A) í°ë”°ì˜´í‘œ ì²˜ë¦¬ (ë³´ë¼ìƒ‰)
              .replace(
                /([â€œ"])([^"â€œâ€]*)([â€"])/g,
                '<span class="highlight-purple">$1$2$3</span>'
              )
              // (B) ë³„í‘œ 2ê°œ(**) ì²˜ë¦¬ (êµµê²Œ)
              .replace(
                /\*\*([\s\S]+?)\*\*/g,
                '<span class="highlight-bold">$1</span>'
              )
              // (C) ë³„í‘œ 1ê°œ(*) ì²˜ë¦¬ (íšŒìƒ‰ + ì´íƒ¤ë¦­)
              .replace(
                /\*(\S[\s\S]*?\S)\*/g,
                '<span class="highlight-action">$1</span>' 
              );

            const wrapper = document.createElement('div');
            wrapper.className = 'bubble-wrapper';

            const meta = document.createElement('div');
            // ì´ë¦„ ì •ë ¬ í´ë˜ìŠ¤ ì¶”ê°€
            meta.className = 'meta ' + (isUser ? 'from-user-meta' : 'from-bot-meta'); 
            meta.textContent = name;

            const bubble = document.createElement('div');
            bubble.className = 'message ' + (isUser ? 'from-user' : 'from-bot');
            
            bubble.innerHTML = formattedMessage;

            wrapper.appendChild(meta);
            wrapper.appendChild(bubble);
            chat.appendChild(wrapper);
            
            messageCount++; // ì„±ê³µì ìœ¼ë¡œ ë Œë”ë§ëœ ë©”ì‹œì§€ ìˆ˜ ì¦ê°€

          } catch (err) {
            console.error("JSON íŒŒì‹± ì‹¤íŒ¨:", err, line);
            // ëª¨ë°”ì¼ì—ì„œ ì—ëŸ¬ í™•ì¸ì´ ì–´ë ¤ìš°ë¯€ë¡œ ì½˜ì†” ì—ëŸ¬ë¥¼ ë‚¨ê¹ë‹ˆë‹¤.
          }
        });
        
        // ìœ íš¨ ë©”ì‹œì§€ê°€ í•˜ë‚˜ë„ ì—†ì„ ë•Œ í”¼ë“œë°± ì œê³µ
        if (messageCount === 0) {
             chat.innerHTML = '<div style="color: red; text-align: center; margin-top: 20px;">íŒŒì¼ì„ ì½ì—ˆìœ¼ë‚˜, í‘œì‹œí•  ìˆ˜ ìˆëŠ” ìœ íš¨í•œ ì±„íŒ… ë©”ì‹œì§€(JSON ê°ì²´ì™€ "mes" í•„ë“œ)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</div>';
        }
      };
      
      // íŒŒì¼ì„ UTF-8ë¡œ ì½ìŠµë‹ˆë‹¤.
      reader.readAsText(file, "utf-8");
    });
  
    // --- ì¶”ê°€ ê¸°ëŠ¥ ìŠ¤í¬ë¦½íŠ¸ ---

    // 1. íŒŒì¼ ì„ íƒ ì‹œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
    document.getElementById('fileInput').addEventListener('change', function(e) {
      const fileName = e.target.files[0] ? e.target.files[0].name : 'ğŸ“‚ íŒŒì¼ ì„ íƒ';
      document.querySelector('.custom-file-btn').textContent = fileName;
    });

    // 2. ìƒ‰ìƒ ë³€ê²½ ë¡œì§
    const root = document.documentElement;

    document.getElementById('userColor').addEventListener('input', (e) => {
      root.style.setProperty('--user-bg', e.target.value);
    });

    document.getElementById('botColor').addEventListener('input', (e) => {
      root.style.setProperty('--bot-bg', e.target.value);
    });

    // ëŒ€ì‚¬(ë³´ë¼ìƒ‰ ë¶€ë¶„) ìƒ‰ìƒ ë³€ê²½
    document.getElementById('highlightColor').addEventListener('input', (e) => {
      root.style.setProperty('--highlight-color', e.target.value);
    });

  </script>
</body>
</html>
